<!DOCTYPE html>
<meta charset="utf-8">
<title>Game of Life</title>
<h1>Game of Life</h1>

<div id="field">
</div>

<script src="http://code.jquery.com/jquery-2.1.1.min.js" charset="utf-8"></script>

<script type="text/javascript">
    var width = 10;
    var height = 10;
    var interval = 1000;
    var ws = null;
    var flips = [];

    function createOnClick(i, j) {
        return function () {
            var o = $(this);
            if ("death" === o.attr("class")) {
                o.attr("class", "life");
            } else {
                o.attr("class", "death");
            }

            var exist = false;
            for (var k = 0; k < flips.length; ++k) {
                if (flips[k][0] === i && flips[k][1] === i) {
                    flips.splice(k, 1);
                    exist = true;
                    break;
                }
            }

            if (exist === false) {
                flips.push([i,j]);
            }
        };
    }

    function initializeField(width, height) {
        var ft = $("<table>");
        for (var j = 0; j < height; ++j) {
            var row = $("<tr>");
            for (var i = 0; i < width; ++i) {
                var id = "tile-" + i + "-" + j;
                var e = $("<td class=\"death\"></td>");
                e.attr("id", id);
                e.attr("class", "death");
                e.click(createOnClick(i, j));
                row.append(e);
            };
            ft.append(row);
        }
        $("#field").html(ft);
    }

    function sendMessage() {
        ws.send(JSON.stringify(flips));
        flips = [];
    }

    function routine() {
        if (ws == null || ws.readyState != 1) {
            ws = new WebSocket("ws://localhost:3000");

            ws.onopen = function () {
                console.log("onOpen");
            };

            ws.onerror = function (error) {
                console.log("onError", error);
            };

            ws.onmessage = function (m) {
                console.log("onMessage", m);
                var fieldData = $.parseJSON(m.data);

                for (var i = 0; i < width; ++i) {
                    for (var j = 0; j < height; ++j) {
                        var id = "#tile-" + i + "-" + j;
                        if (fieldData[i][j] == true) {
                            $(id).attr("class", "life");
                        } else {
                            $(id).attr("class", "death");
                        }
                    }
                }
            };

            ws.onclose = function () {
                console.log("onClose");
            };
        }

        sendMessage();
    }

    initializeField(width, height);
    setInterval(routine, interval);
</script>

<style type="text/css">
table {
    border-collapse: collapse;
}

td {
    width: 30px;
    border: 1px solid black;
}

tr {
    height: 30px;
    border: none;
}

.life
{
    background-color: black;
}

.death
{
    background-color: white;
}
</style>
